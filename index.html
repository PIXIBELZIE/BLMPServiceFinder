<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belmopan Service Finder</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .vendor-card { transition: all 0.2s ease; }
        .vendor-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 100; }
        .ad-placeholder { background-color: #fff; border-left: 4px solid #f97316; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .menu-category { border-bottom: 2px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1.5rem; }
    </style>
</head>
<body class="min-h-screen">

    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Belmopan <span class="text-orange-600">Service Finder</span></h1>
            <p class="mt-2 text-lg text-gray-500">Find Restaurants, Taxis, and Local Services with detailed menus and prices.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar for Ads -->
            <aside class="hidden lg:block lg:col-span-1">
                <div id="ad-sidebar">
                    <!-- Ads will be inserted here -->
                    <div class="ad-placeholder text-center text-gray-400">
                        <p class="text-sm font-semibold text-orange-600 mb-2">AD SPACE</p>
                        <i data-lucide="megaphone" class="mx-auto h-8 w-8"></i>
                        <p class="text-xs mt-2">No active ads currently displayed.</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="lg:col-span-3">

                <!-- Search and List View -->
                <div id="list-view">
                    <!-- Search Bar and Filter -->
                    <div class="mb-8 p-4 bg-white shadow-lg rounded-xl flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="applyFilters()"
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-base"
                                placeholder="Search food (Wings, Tacos), Service ID (BPN001), or Name...">
                        </div>
                        <div class="relative">
                            <i data-lucide="filter" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            <select id="type-filter" onchange="applyFilters()"
                                class="w-full sm:w-48 pl-10 pr-4 py-3 border border-gray-300 rounded-lg appearance-none focus:ring-orange-500 focus:border-orange-500 bg-white text-base">
                                <option value="">All Services</option>
                                <!-- Types will be populated by JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Vendor List -->
                    <div id="vendor-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Vendor Cards will be inserted here by JavaScript -->
                    </div>

                    <!-- No Results Message -->
                    <p id="no-results" class="text-center text-gray-500 mt-10 text-xl hidden">
                        No services found matching your criteria. Try a broader search!
                    </p>
                </div>

                <!-- Profile View -->
                <div id="profile-view" class="hidden">
                    <button onclick="showListView()" class="mb-6 inline-flex items-center text-orange-600 hover:text-orange-800 font-medium p-2 rounded-lg bg-orange-50 hover:bg-orange-100 transition">
                        <i data-lucide="arrow-left" class="h-5 w-5 mr-2"></i>
                        Back to Search Results
                    </button>
                    <div id="profile-details" class="bg-white p-6 shadow-xl rounded-xl">
                        <!-- Profile content will be inserted here by JavaScript -->
                    </div>
                    
                    <!-- Delivery Suggestion Block -->
                    <div id="delivery-suggestions" class="mt-8">
                        <!-- Delivery vendors will be suggested here -->
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // !! IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR DEPLOYED APPS SCRIPT URL !!
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-tWFjR-3A7y0xdHmq0R3Zop-l9McjPcBYwF89POke02LRWsNFnlHghA9SGdGQIg4/exec"; 

        // Global state
        let allVendors = [];
        let deliveryVendors = []; // To hold only Delivery services for suggestions
        let vendorTypes = new Set(); // To hold unique service types for the filter

        /**
         * Converts a simple string to a URL for an icon or image.
         */
        function getIconUrl(url, fallbackText) {
            if (url && (url.startsWith('http') || url.startsWith('data:'))) {
                // If it looks like a valid URL, return it
                return url;
            }
            // Use a placeholder image with initials if no valid URL is present
            const initials = fallbackText.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            return `https://placehold.co/80x80/22c55e/ffffff?text=${encodeURIComponent(initials)}`;
        }

        /**
         * Renders the list of vendor cards based on the search query and filter.
         */
        function renderVendorList(vendors) {
            const listContainer = document.getElementById('vendor-list');
            const noResults = document.getElementById('no-results');
            listContainer.innerHTML = '';

            if (vendors.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            vendors.forEach(vendor => {
                const card = document.createElement('div');
                card.className = 'vendor-card bg-white p-5 rounded-xl shadow-md border border-gray-100 cursor-pointer flex flex-col justify-between';
                card.onclick = () => showProfileView(vendor.VendorID);

                const iconUrl = getIconUrl(vendor.ProfileIconURL, vendor.Name);
                // FIX: Added (vendor.SearchKeywords || '') to prevent crash if SearchKeywords is null/undefined
                const keywords = (vendor.SearchKeywords || '').split(',').slice(0, 5).map(s => `<span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full mr-1 mb-1">${s.trim()}</span>`).join('');

                // Calculate price summary for the card display
                let priceSummary = 'View Menu/Details';
                if (vendor.DataJSON && vendor.DataJSON.length > 0 && vendor.DataJSON[0].items) {
                    const firstItem = vendor.DataJSON[0].items[0];
                    if (firstItem && firstItem.price) {
                        priceSummary = `Starting at: ${firstItem.price}`;
                    }
                }
                
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.Name}')" class="w-16 h-16 rounded-full object-cover mr-4 ring-2 ring-orange-500 p-0.5" alt="${vendor.Name} Logo">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">${vendor.Name}</h2>
                            <p class="text-sm text-orange-600 font-semibold">${vendor.Type} - ID: ${vendor.VendorID}</p>
                        </div>
                    </div>
                    <p class="text-sm font-semibold text-green-700 mb-3">${priceSummary}</p>
                    <div class="mt-auto">
                        <p class="text-sm font-medium text-gray-800 mb-1">Keywords:</p>
                        <div class="flex flex-wrap">${keywords}</div>
                    </div>
                `;
                listContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        /**
         * Filters the vendor list based on search input and type filter.
         */
        function applyFilters() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const typeFilter = document.getElementById('type-filter').value;

            const filteredVendors = allVendors.filter(vendor => {
                const matchesQuery = !query || 
                                     vendor.Name.toLowerCase().includes(query) ||
                                     vendor.VendorID.toLowerCase().includes(query) ||
                                     // FIX: Added (vendor.SearchKeywords || '') defensive check here too
                                     (vendor.SearchKeywords || '').toLowerCase().includes(query) ||
                                     vendor.Type.toLowerCase().includes(query);
                
                const matchesType = !typeFilter || vendor.Type === typeFilter;
                
                return matchesQuery && matchesType;
            });

            renderVendorList(filteredVendors);
        }

        /**
         * Populates the Service Type filter dropdown.
         */
        function populateTypeFilter() {
            const filterEl = document.getElementById('type-filter');
            // Clear previous options
            filterEl.querySelectorAll('option:not([value=""])').forEach(opt => opt.remove());

            vendorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterEl.appendChild(option);
            });
        }

        /**
         * Renders the full, categorized menu from the DataJSON object.
         */
        function renderMenu(dataJson) {
            if (!dataJson || dataJson.length === 0) {
                return '<p class="text-gray-500">No detailed menu or service list available.</p>';
            }

            let menuHTML = '';

            dataJson.forEach(category => {
                menuHTML += `
                    <div class="menu-category">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${category.category}</h3>
                        <p class="text-gray-600 mb-4">${category.description || ''}</p>
                        <div class="space-y-3">
                `;
                category.items.forEach(item => {
                    menuHTML += `
                        <div class="flex justify-between items-start border-b border-gray-100 pb-2">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-500 italic">${item.desc || ''}</p>
                            </div>
                            <p class="text-lg font-bold text-orange-600 flex-shrink-0 ml-4">${item.price || 'Varies'}</p>
                        </div>
                    `;
                });
                menuHTML += `
                        </div>
                    </div>
                `;
            });

            return menuHTML;
        }

        /**
         * Renders suggestions for Delivery services, only if the current vendor is a Restaurant.
         */
        function renderDeliverySuggestions(currentVendor) {
            const suggestionsContainer = document.getElementById('delivery-suggestions');
            suggestionsContainer.innerHTML = '';
            
            if (currentVendor.Type !== 'Restaurant' || deliveryVendors.length === 0) {
                return; // Only suggest delivery for restaurants
            }

            // Show max 3 random delivery vendors
            const shuffledDelivery = deliveryVendors.sort(() => 0.5 - Math.random());
            let deliveryCards = shuffledDelivery.slice(0, 3).map(vendor => { 
                const iconUrl = getIconUrl(vendor.ProfileIconURL, vendor.Name);
                return `
                    <div class="flex items-center p-4 bg-white rounded-lg shadow-sm border border-orange-200 cursor-pointer transition hover:bg-orange-50" onclick="showProfileView('${vendor.VendorID}')">
                        <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.Name}')" class="w-10 h-10 rounded-full object-cover mr-3" alt="${vendor.Name} Logo">
                        <div>
                            <p class="font-semibold text-gray-900">${vendor.Name}</p>
                            <p class="text-sm text-orange-600">Tap to see rates</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 ml-auto text-gray-400"></i>
                    </div>
                `;
            }).join('');

            suggestionsContainer.innerHTML = `
                <div class="p-5 bg-orange-100 rounded-xl">
                    <h2 class="text-2xl font-bold text-orange-800 mb-4">Need Delivery for ${currentVendor.Name}?</h2>
                    <p class="text-gray-700 mb-4">Check out these trusted local delivery services who can bring your order right to your door:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${deliveryCards}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Renders the detailed profile view for a specific vendor.
         */
        function renderProfile(vendor) {
            const profileContainer = document.getElementById('profile-details');
            const iconUrl = getIconUrl(vendor.ProfileIconURL, vendor.Name);

            let contactItems = '';
            if (vendor.ContactPhone) {
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="phone" class="h-5 w-5 text-gray-500 mr-3"></i><a href="tel:${vendor.ContactPhone}" class="text-blue-600 hover:underline">${vendor.ContactPhone}</a></div>`;
            }
            if (vendor.WhatsApp) {
                const whatsappNumber = String(vendor.WhatsApp).replace(/\D/g, ''); // Clean number for link
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="message-square" class="h-5 w-5 text-green-500 mr-3"></i><a href="https://wa.me/${whatsappNumber}" target="_blank" class="text-green-600 hover:underline">Chat on WhatsApp</a></div>`;
            }
            if (vendor.SocialMedia) {
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="users" class="h-5 w-5 text-purple-500 mr-3"></i><a href="${vendor.SocialMedia}" target="_blank" class="text-purple-600 hover:underline">Social Media Profile</a></div>`;
            }

            profileContainer.innerHTML = `
                <div class="flex flex-col md:flex-row items-center md:items-start border-b pb-6 mb-6">
                    <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.Name}')" class="w-24 h-24 rounded-full object-cover mb-4 md:mb-0 md:mr-6 ring-4 ring-orange-500 p-0.5" alt="${vendor.Name} Logo">
                    <div>
                        <h1 class="text-3xl font-extrabold text-gray-900">${vendor.Name}</h1>
                        <p class="text-lg text-orange-600 font-medium">${vendor.Type} Service</p>
                        <p class="text-sm text-gray-500 mt-1">Service ID: ${vendor.VendorID}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Contact Details Column -->
                    <div class="lg:col-span-1">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Contact Details</h2>
                        ${contactItems || '<p class="text-gray-500">No contact information provided.</p>'}
                    </div>

                    <!-- Searchable Keywords Column -->
                     <div class="lg:col-span-2">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Search Keywords</h2>
                        <p class="text-gray-800">${(vendor.SearchKeywords || '').split(',').map(s => `<span class="inline-block bg-orange-100 text-orange-800 text-sm px-2 py-0.5 rounded-full mr-1 mb-1">${s.trim()}</span>`).join('')}</p>
                    </div>
                </div>

                <!-- Categorized Menu/Services -->
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Service & Pricing Details</h2>
                    ${renderMenu(vendor.DataJSON)}
                </div>
            `;
            // Suggest delivery services if it's a restaurant
            renderDeliverySuggestions(vendor);
            lucide.createIcons();
        }

        /**
         * Renders the Ad sidebar from all available approved AdContent.
         */
        function renderAdSidebar() {
            const adSidebar = document.getElementById('ad-sidebar');
            adSidebar.innerHTML = '';
            
            // Collect all vendors with valid ad content
            const availableAds = allVendors.filter(v => v.AdContent && v.AdContent.title && v.AdContent.body);

            if (availableAds.length === 0) {
                 adSidebar.innerHTML = `
                    <div class="ad-placeholder text-center text-gray-400">
                        <p class="text-sm font-semibold text-orange-600 mb-2">AD SPACE</p>
                        <i data-lucide="megaphone" class="mx-auto h-8 w-8"></i>
                        <p class="text-xs mt-2">No active ads currently displayed.</p>
                    </div>
                 `;
            } else {
                // For simplicity, pick a random ad to display
                const randomAd = availableAds[Math.floor(Math.random() * availableAds.length)];
                
                adSidebar.innerHTML = `
                    <div class="ad-placeholder">
                        <p class="text-sm font-semibold text-orange-600">FEATURED AD</p>
                        <h3 class="text-xl font-bold text-gray-900 mt-1">${randomAd.AdContent.title}</h3>
                        <p class="text-gray-700 mt-2 text-sm">${randomAd.AdContent.body}</p>
                        <button onclick="showProfileView('${randomAd.VendorID}')" class="mt-3 w-full bg-orange-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-orange-700 transition">
                            View Offer
                        </button>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        /**
         * Switches the view to the profile view for a specific vendor.
         */
        function showProfileView(vendorId) {
            const vendor = allVendors.find(v => v.VendorID === vendorId);
            if (!vendor) {
                console.error("Vendor not found:", vendorId);
                // Fallback: simple message box
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold text-red-600 mb-4">Error</h3>
                            <p>Service profile not found for ID: ${vendorId}</p>
                            <button onclick="document.getElementById('error-modal').remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Close</button>
                        </div>
                    </div>
                `);
                return;
            }
            renderProfile(vendor);
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');
            window.scrollTo(0, 0); // Scroll to top for a clean view transition
        }

        /**
         * Switches the view back to the list (search) view.
         */
        function showListView() {
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('list-view').classList.remove('hidden');
            applyFilters(); // Re-render the filtered/full list
        }


        /**
         * Initial data fetch from the Apps Script API.
         */
        async function fetchData() {
            if (APP_SCRIPT_URL === "APP_SCRIPT_URL_PLACEHOLDER") {
                 console.error("FATAL ERROR: Please replace APP_SCRIPT_URL_PLACEHOLDER with your actual deployed Google Apps Script URL.");
                 return;
            }

            const loadingEl = document.getElementById('loading-overlay');
            loadingEl.classList.remove('hidden');

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(APP_SCRIPT_URL, { method: 'GET' });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.status === "success") {
                        allVendors = result.data;
                        
                        // Populate vendor types for filtering
                        allVendors.forEach(vendor => {
                            vendorTypes.add(vendor.Type);
                            // Separate delivery vendors for easy suggestions
                            if (vendor.Type === 'Delivery') {
                                deliveryVendors.push(vendor);
                            }
                        });

                        populateTypeFilter();
                        applyFilters(); // Initial render of the list
                        renderAdSidebar(); // Render the ads
                        loadingEl.classList.add('hidden');
                        return;
                    } else {
                        throw new Error(result.message || "Failed to retrieve data.");
                    }

                } catch (error) {
                    // console.error(`Attempt ${attempt + 1}: Failed to fetch data.`, error.message);
                    if (attempt === maxRetries - 1) {
                        // Display error to the user if all retries fail
                        document.body.insertAdjacentHTML('beforeend', `
                            <div id="load-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                                <div class="bg-white p-6 rounded-lg shadow-2xl">
                                    <h3 class="text-xl font-bold text-red-600 mb-4">Connection Error</h3>
                                    <p class="mb-4">Could not load service data. Please ensure the Apps Script URL is correct and deployed as a public web app.</p>
                                    <p class="text-sm text-gray-500">Details: ${error.message}</p>
                                    <button onclick="document.getElementById('load-error-modal').remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Acknowledge</button>
                                </div>
                            </div>
                        `);
                        loadingEl.classList.add('hidden');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, currentDelay));
                    currentDelay *= 2; 
                }
            }
        }

        // Initialize the application on page load
        window.onload = function() {
            fetchData();
        };

    </script>
</body>
</html>
