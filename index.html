<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belmopan Service Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .vendor-card { transition: all 0.2s ease; }
        .vendor-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 100; }
        .ad-placeholder { background-color: #fff; border-left: 4px solid #f97316; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .menu-category { border-bottom: 2px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        /* Style for the comparison list inside the card */
        .comparison-list-wrapper { max-height: 100px; overflow-y: auto; padding-right: 4px; border-radius: 4px; }
        .comparison-list-wrapper::-webkit-scrollbar { width: 6px; }
        .comparison-list-wrapper::-webkit-scrollbar-thumb { background: #fed7aa; border-radius: 3px; }

        /* NEW: Orange Gradient "Status" Ring CSS */
        .menu-status-ring-shared {
            /* orange-500 via pink-500 to red-600 */
            background-image: linear-gradient(to right, #f97316, #ec4899, #dc2626);
            border-radius: 9999px; /* full */
            transition: all 0.2s ease;
        }
        .menu-status-ring-shared:hover {
            background-image: linear-gradient(to right, #ea580c, #d946ef, #b91c1c); /* Darker hover */
        }
        
        /* For the w-16 h-16 card image */
        .menu-status-ring-card {
            padding: 2px; /* Ring width for card */
        }
        
        /* For the w-24 h-24 profile image */
        .menu-status-ring-profile {
            padding: 3px; /* Ring width for profile */
        }

        /* Class to trigger slide-out for mobile ad */
        .slide-out {
            transform: translateY(200%) !important;
        }

        /* NEW: Styles for status progress bars */
        .status-progress-bar {
            height: 3px;
            border-radius: 3px;
            background-color: rgba(255, 255, 255, 0.3);
            flex-grow: 1;
        }
        .status-progress-bar-filled {
            background-color: white;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Belmopan <span class="text-orange-600">Service Finder</span></h1>
            <p class="mt-2 text-lg text-gray-500">Find Restaurants, Taxis, and Local Services with detailed menus and prices.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <aside class="hidden lg:block lg:col-span-1">
                <div id="ad-sidebar">
                    <div class="ad-placeholder text-center text-gray-400">
                        <p class="text-sm font-semibold text-orange-600 mb-2">AD SPACE</p>
                        <i data-lucide="megaphone" class="mx-auto h-8 w-8"></i>
                        <p class="text-xs mt-2">No active ads currently displayed.</p>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-3">

                <div id="list-view">
                    <div class="mb-8 p-4 bg-white shadow-lg rounded-xl flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="applyFilters()"
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-base"
                                placeholder="Search 'Stew Chicken' or a Business Name...">
                        </div>
                        <div class="relative">
                            <i data-lucide="filter" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            <select id="type-filter" onchange="applyFilters()"
                                class="w-full sm:w-48 pl-10 pr-4 py-3 border border-gray-300 rounded-lg appearance-none focus:ring-orange-500 focus:border-orange-500 bg-white text-base">
                                <option value="">All Services</option>
                                </select>
                        </div>
                    </div>

                    <div id="vendor-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        </div>

                    <p id="no-results" class="text-center text-gray-500 mt-10 text-xl hidden">
                        No services or menu items found matching your criteria. Try a broader search!
                    </p>
                </div>

                <div id="profile-view" class="hidden">
                    <button onclick="showListView()" class="mb-6 inline-flex items-center text-orange-600 hover:text-orange-800 font-medium p-2 rounded-lg bg-orange-50 hover:bg-orange-100 transition">
                        <i data-lucide="arrow-left" class="h-5 w-5 mr-2"></i>
                        Back to Search Results
                    </button>
                    <div id="profile-details" class="bg-white p-6 shadow-xl rounded-xl">
                        </div>
                    
                    <div id="delivery-suggestions" class="mt-8">
                        </div>
                </div>

            </main>
        </div>
    </div>

    <div id="mobile-ad-toast" class="fixed bottom-4 left-4 right-4 z-40 lg:hidden transform translate-y-[200%] transition-transform duration-700 ease-in-out">
        </div>

    <footer class="mt-12 bg-gray-900 text-white">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-lg font-semibold text-orange-500">
                Pixi Belize
            </p>
            <p class="mt-2 text-base text-gray-400">
                Connecting Belmopan's local services.
            </p>
            <p class="mt-4 text-sm text-gray-400">
                This service is free for all local vendors.
            </p>
            <p class="mt-1 text-sm text-gray-400">
                Interested in adding your business? Contact us to join!
            </p>
            <p class="mt-6 text-xs text-gray-500" id="footer-copy">
                &copy; 2024 Belmopan Service Finder. All rights reserved.
            </p>
        </div>
    </footer>

    <div id="menu-picture-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden" onclick="hideMenuPictureModal()">
        
        <div class="relative w-full max-w-lg m-4" onclick="event.stopPropagation()">
            
            <div class="absolute top-0 left-0 right-0 p-3 bg-gradient-to-b from-black/70 to-transparent z-20">
                <div id="status-progress-bars" class="flex items-center gap-1 mb-2">
                    </div>
                <div class="flex items-center">
                    <i data-lucide="image" class="h-5 w-5 text-white mr-2"></i>
                    <h3 id="menu-modal-title" class="text-lg font-medium text-white">Menu Photo</h3>
                    <button onclick="hideMenuPictureModal()" class="ml-auto text-gray-300 hover:text-white">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>

            <div class="bg-black rounded-lg">
                 <img id="menu-modal-image" src="" class="w-full h-auto max-h-[80vh] object-contain rounded-lg" alt="Menu Picture">
            </div>

            <button id="status-prev-btn" onclick="prevStatus(event)" class="absolute left-0 top-1/2 -translate-y-1/2 p-3 text-white opacity-70 hover:opacity-100 z-30">
                <i data-lucide="chevron-left" class="h-10 w-10"></i>
            </button>
            <button id="status-next-btn" onclick="nextStatus(event)" class="absolute right-0 top-1/2 -translate-y-1/2 p-3 text-white opacity-70 hover:opacity-100 z-30">
                <i data-lucide="chevron-right" class="h-10 w-10"></i>
            </button>

        </div>
    </div>

    <script>
        // !! IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR DEPLOYED APPS SCRIPT URL !!
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-tWFjR-3A7y0xdHmq0R3Zop-l9McjPcBYwF89POke02LRWsNFnlHghA9SGdGQIg4/exec"; 

        // Global state
        let allVendors = [];
        let deliveryVendors = []; 
        let vendorTypes = new Set();
        let matchingItemsMap = {}; 

        // NEW: Global state for Status Gallery
        let currentStatusImages = [];
        let currentStatusIndex = 0;

        /**
         * Converts a simple string to a URL for an icon or image.
         */
        function getIconUrl(url, fallbackText) {
            if (url && (url.startsWith('http') || url.startsWith('data:'))) {
                return url;
            }
            const initials = fallbackText.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            return `https://placehold.co/80x80/22c55e/ffffff?text=${encodeURIComponent(initials)}`;
        }

        /**
         * NEW: Updates the modal content (image, title, progress, buttons)
         */
        function updateStatusModal() {
            if (currentStatusImages.length === 0) return;

            // 1. Update Image
            document.getElementById('menu-modal-image').src = currentStatusImages[currentStatusIndex];

            // 2. Update Progress Bars
            const progressBarContainer = document.getElementById('status-progress-bars');
            progressBarContainer.innerHTML = ''; // Clear old bars
            for (let i = 0; i < currentStatusImages.length; i++) {
                const bar = document.createElement('div');
                bar.className = 'status-progress-bar';
                if (i <= currentStatusIndex) {
                    bar.classList.add('status-progress-bar-filled');
                }
                progressBarContainer.appendChild(bar);
            }

            // 3. Update Button Visibility
            document.getElementById('status-prev-btn').style.display = currentStatusIndex === 0 ? 'none' : 'block';
            document.getElementById('status-next-btn').style.display = currentStatusIndex === currentStatusImages.length - 1 ? 'none' : 'block';
            
            // 4. Ensure icons are rendered
            lucide.createIcons();
        }

        /**
         * NEW: Go to next status image
         */
        function nextStatus(event) {
            event.stopPropagation();
            if (currentStatusIndex < currentStatusImages.length - 1) {
                currentStatusIndex++;
                updateStatusModal();
            }
        }

        /**
         * NEW: Go to previous status image
         */
        function prevStatus(event) {
            event.stopPropagation();
            if (currentStatusIndex > 0) {
                currentStatusIndex--;
                updateStatusModal();
            }
        }

        /**
         * UPDATED: Shows the menu picture modal gallery.
         */
        function showMenuPictureModal(imageUrls, vendorName) {
            // Split by comma and filter out any empty strings
            currentStatusImages = (imageUrls || '').split(',').map(url => url.trim()).filter(url => url);

            if (currentStatusImages.length === 0) {
                console.warn("Attempted to show status modal with no images.");
                return;
            }
            
            currentStatusIndex = 0;
            
            document.getElementById('menu-modal-title').innerText = `${vendorName}'s Menu (${currentStatusIndex + 1}/${currentStatusImages.length})`;
            document.getElementById('menu-picture-modal').classList.remove('hidden');

            updateStatusModal(); // Initial render
        }

        /**
         * UPDATED: Hides the menu picture modal and resets state.
         */
        function hideMenuPictureModal() {
            document.getElementById('menu-picture-modal').classList.add('hidden');
            document.getElementById('menu-modal-image').src = ''; // Clear src
            // Reset state
            currentStatusImages = [];
            currentStatusIndex = 0;
            document.getElementById('status-progress-bars').innerHTML = '';
        }

        /**
         * Generates the HTML for social media icons based on vendor data.
         */
        function renderSocialIcons(vendor) {
            let icons = '';
            if (vendor.ContactPhone) icons += `<a href="tel:${vendor.ContactPhone}" title="Call ${vendor.Name}" class="text-gray-500 hover:text-orange-600"><i data-lucide="phone" class="h-5 w-5"></i></a>`;
            if (vendor.WhatsApp) {
                const whatsappNumber = String(vendor.WhatsApp || '').replace(/\D/g, ''); 
                if (whatsappNumber) icons += `<a href="https://wa.me/${whatsappNumber}" target="_blank" title="WhatsApp ${vendor.Name}" class="text-gray-500 hover:text-green-500"><i data-lucide="message-square" class="h-5 w-5"></i></a>`;
            }
            if (vendor.FacebookURL) icons += `<a href="${vendor.FacebookURL}" target="_blank" title="Facebook" class="text-gray-500 hover:text-blue-700"><i data-lucide="facebook" class="h-5 w-5"></i></a>`;
            if (vendor.InstagramURL) icons += `<a href="${vendor.InstagramURL}" target="_blank" title="Instagram" class="text-gray-500 hover:text-pink-600"><i data-lucide="instagram" class="h-5 w-5"></i></a>`;
            return icons;
        }


        /**
         * Renders the list of vendor cards based on the search query and filter.
         */
        function renderVendorList(vendors, currentQuery, matchedItemsMap) {
            const listContainer = document.getElementById('vendor-list');
            const noResults = document.getElementById('no-results');
            listContainer.innerHTML = '';

            if (vendors.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            vendors.forEach(vendor => {
                const card = document.createElement('div');
                card.className = 'vendor-card bg-white p-5 rounded-xl shadow-md border border-gray-100 cursor-pointer flex flex-col justify-between';
                card.onclick = () => showProfileView(vendor.VendorID);

                const iconUrl = getIconUrl(vendor.ProfileIconURL, vendor.Name);
                const contactIcons = renderSocialIcons(vendor);
                const matchedItems = matchedItemsMap[vendor.VendorID];

                const verifiedBadge = vendor.IsVerified ? `<span class="ml-1.5 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" title="Verified Vendor"><i data-lucide="shield-check" class="h-3 w-3 mr-1"></i>Verified</span>` : '';

                let cardContentHTML = '';
                
                // Determine if we are in comparison mode (specific item search) or general view
                if (currentQuery && matchedItems && matchedItems.length > 0) {
                    // COMPARISON VIEW: Show specific matched items
                    cardContentHTML = `
                        <p class="text-sm font-semibold text-gray-700 mb-2">Items matching "<strong>${currentQuery}</strong>":</p>
                        <div class="comparison-list-wrapper bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <div class="space-y-1">
                                ${matchedItems.slice(0, 10).map(item => `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-800 font-medium truncate">${item.name}</span>
                                        <span class="text-orange-600 font-bold flex-shrink-0 ml-2">${item.price}</span>
                                    </div>
                                `).join('')}
                                ${matchedItems.length > 10 ? `<p class="text-xs text-gray-500 mt-1">...and ${matchedItems.length - 10} more items</p>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // REVERTED DEFAULT VIEW: Show Location and "View Profile"
                    cardContentHTML = `
                        <div class="mt-2 mb-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <i data-lucide="map-pin" class="h-4 w-4 mr-2 text-orange-500"></i>
                                <span>${vendor.Location || 'Location not specified'}</span>
                            </div>
                            <p class="text-base font-semibold text-orange-600 mt-3 hover:underline">
                                View Profile & Menu Details
                            </p>
                        </div>
                    `;
                }
                
                // NEW: Status Ring logic for CARD
                const hasMenuPicture = vendor.MenuPictureURL && vendor.MenuPictureURL.trim() !== '';
                const ringWrapperStart = hasMenuPicture
                    ? `<div class="menu-status-ring-shared menu-status-ring-card cursor-pointer" onclick="event.stopPropagation(); showMenuPictureModal('${vendor.MenuPictureURL}', '${vendor.Name}')" title="View Menu Status">`
                    : `<div class="ring-2 ring-orange-500 p-0.5 rounded-full">`;
                const ringWrapperEnd = `</div>`;
                const imageClass = hasMenuPicture ? 'border-2 border-white' : ''; // Inner border for gradient
                
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        ${ringWrapperStart}
                            <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.Name}')" class="w-16 h-16 rounded-full object-cover ${imageClass}" alt="${vendor.Name} Logo">
                        ${ringWrapperEnd}
                        <div class="ml-4">
                            <h2 class="text-xl font-bold text-gray-900">${vendor.Name}</h2>
                            <p class="text-sm text-orange-600 font-semibold flex items-center">${vendor.Type}${verifiedBadge}</p>
                        </div>
                    </div>
                    ${cardContentHTML}
                    <div class="mt-auto pt-3 border-t flex space-x-3">
                        ${contactIcons}
                    </div>
                `;
                listContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        /**
         * Filters the vendor list based on search input and type filter.
         */
        function applyFilters() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const typeFilter = document.getElementById('type-filter').value;
            
            matchingItemsMap = {}; 

            const filteredVendors = allVendors.filter(vendor => {
                let matchesQuery = false;
                
                const searchableText = `${vendor.Name || ''} ${vendor.Location || ''} ${vendor.SearchKeywords || ''}`.toLowerCase();
                if (searchableText.includes(query)) {
                    matchesQuery = true;
                }

                const matchedItems = [];
                if (vendor.DataJSON && Array.isArray(vendor.DataJSON)) {
                    vendor.DataJSON.forEach(category => {
                        if (category.items && Array.isArray(category.items)) {
                            category.items.forEach(item => {
                                if ((item.name || '').toLowerCase().includes(query) || (item.desc || '').toLowerCase().includes(query)) {
                                    matchedItems.push({
                                        name: item.name,
                                        price: item.price || 'Price N/A'
                                    });
                                    matchesQuery = true; 
                                }
                            });
                        }
                    });
                }

                if (matchedItems.length > 0) {
                    matchingItemsMap[vendor.VendorID] = matchedItems;
                }
                
                const matchesType = !typeFilter || vendor.Type === typeFilter;
                
                return matchesQuery && matchesType;
            });

            renderVendorList(filteredVendors, query, matchingItemsMap);
        }

        /**
         * Populates the Service Type filter dropdown.
         */
        function populateTypeFilter() {
            const filterEl = document.getElementById('type-filter');
            filterEl.querySelectorAll('option:not([value=""])').forEach(opt => opt.remove());

            vendorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterEl.appendChild(option);
            });
        }

        /**
         * Renders the full, categorized menu from the DataJSON object.
         */
        function renderMenu(dataJson) {
            if (!dataJson || dataJson.length === 0) {
                return '<p class="text-gray-500">No detailed menu or service list available.</p>';
            }

            let menuHTML = '';
            const categories = Array.isArray(dataJson) ? dataJson : [{ category: "Details", description: "Services offered:", items: dataJson.items || [] }];

            categories.forEach(category => {
                menuHTML += `
                    <div class="menu-category">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${category.category}</h3>
                        <p class="text-gray-600 mb-4">${category.description || ''}</p>
                        <div class="space-y-3">
                `;
                (category.items || []).forEach(item => { 
                    menuHTML += `
                        <div class="flex justify-between items-start border-b border-gray-100 pb-2">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${item.name || 'Untitled Item'}</p>
                                <p class="text-sm text-gray-500 italic">${item.desc || ''}</p>
                            </div>
                            <p class="text-lg font-bold text-orange-600 flex-shrink-0 ml-4">${item.price || 'Varies'}</p>
                        </div>
                    `;
                });
                menuHTML += `</div></div>`;
            });

            return menuHTML;
        }

        /**
         * Renders suggestions for Delivery services.
         */
        function renderDeliverySuggestions(currentVendor) {
            const suggestionsContainer = document.getElementById('delivery-suggestions');
            suggestionsContainer.innerHTML = '';
            
            if (currentVendor.Type !== 'Restaurant' || deliveryVendors.length === 0) {
                return; 
            }

            const shuffledDelivery = deliveryVendors.sort(() => 0.5 - Math.random());
            let deliveryCards = shuffledDelivery.slice(0, 3).map(vendor => { 
                const iconUrl = getIconUrl(vendor.ProfileIconURL, vendor.Name);
                return `
                    <div class="flex items-center p-4 bg-white rounded-lg shadow-sm border border-orange-200 cursor-pointer transition hover:bg-orange-50" onclick="showProfileView('${vendor.VendorID}')">
                        <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.Name}')" class="w-10 h-10 rounded-full object-cover mr-3" alt="${vendor.Name} Logo">
                        <div>
                            <p class="font-semibold text-gray-900">${vendor.Name}</p>
                            <p class="text-sm text-orange-600">Tap to see rates</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 ml-auto text-gray-400"></i>
                    </div>
                `;
            }).join('');

            suggestionsContainer.innerHTML = `
                <div class="p-5 bg-orange-100 rounded-xl">
                    <h2 class="text-2xl font-bold text-orange-800 mb-4">Need Delivery for ${currentVendor.Name}?</h2>
                    <p class="text-gray-700 mb-4">Check out these trusted local delivery services who can bring your order right to your door:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${deliveryCards}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Renders the detailed profile view for a specific vendor.
         */
        function renderProfile(vendor) {
            const profileContainer = document.getElementById('profile-details');
            const iconUrl = getIconUrl(vendor.ProfileIconURL, vendor.Name);

            let contactItems = '';
            
            if (vendor.OpeningHours) contactItems += `<div class="flex items-start mb-2"><i data-lucide="clock" class="h-5 w-5 text-gray-500 mr-3 mt-0.5"></i><span class="text-gray-800">${vendor.OpeningHours.replace(/\n/g, '<br>')}</span></div>`;
            if (vendor.Location) contactItems += `<div class="flex items-center mb-2"><i data-lucide="map-pin" class="h-5 w-5 text-gray-500 mr-3"></i><span class="text-gray-800">${vendor.Location}</span></div>`;
            if (vendor.ContactPhone) contactItems += `<div class="flex items-center mb-2"><i data-lucide="phone" class="h-5 w-5 text-gray-500 mr-3"></i><a href="tel:${vendor.ContactPhone}" class="text-blue-600 hover:underline">${vendor.ContactPhone} (Call)</a></div>`;
            if (vendor.WhatsApp) {
                const whatsappNumber = String(vendor.WhatsApp || '').replace(/\D/g, ''); 
                if (whatsappNumber) contactItems += `<div class="flex items-center mb-2"><i data-lucide="message-square" class="h-5 w-5 text-green-500 mr-3"></i><a href="https://wa.me/${whatsappNumber}" target="_blank" class="text-green-600 hover:underline">Chat on WhatsApp</a></div>`;
            }
            if (vendor.FacebookURL) contactItems += `<div class="flex items-center mb-2"><i data-lucide="facebook" class="h-5 w-5 text-blue-700 mr-3"></i><a href="${vendor.FacebookURL}" target="_blank" class="text-blue-600 hover:underline">Visit Facebook Page</a></div>`;
            if (vendor.InstagramURL) contactItems += `<div class="flex items-center mb-2"><i data-lucide="instagram" class="h-5 w-5 text-pink-600 mr-3"></i><a href="${vendor.InstagramURL}" target="_blank" class="text-pink-600 hover:underline">Visit Instagram Profile</a></div>`;

            // NEW: Status Ring logic for PROFILE
            const hasMenuPicture = vendor.MenuPictureURL && vendor.MenuPictureURL.trim() !== '';
            const titleAttr = hasMenuPicture ? 'title="Click to view menu photo"' : `title="${vendor.Name} Logo"`;
            const ringWrapperStart = hasMenuPicture
                ? `<div class="menu-status-ring-shared menu-status-ring-profile cursor-pointer" onclick="showMenuPictureModal('${vendor.MenuPictureURL}', '${vendor.Name}')" ${titleAttr}>`
                : `<div class="ring-4 ring-orange-500 p-0.5 rounded-full" ${titleAttr}>`;
            const ringWrapperEnd = `</div>`;
            const imageClass = hasMenuPicture ? 'border-2 border-white' : ''; // Inner border for gradient

            const verifiedBadge = vendor.IsVerified ? `<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800" title="Verified Vendor"><i data-lucide="shield-check" class="h-4 w-4 mr-1"></i>Verified</span>` : '';

            profileContainer.innerHTML = `
                <div class="flex flex-col md:flex-row items-center md:items-start border-b pb-6 mb-6">
                    
                    ${ringWrapperStart}
                        <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.Name}')" class="w-24 h-24 rounded-full object-cover ${imageClass}" alt="${vendor.Name} Logo">
                    ${ringWrapperEnd}

                    <div class="md:ml-6 mt-4 md:mt-0">
                        <h1 class="text-3xl font-extrabold text-gray-900">${vendor.Name}</h1>
                        <p class="text-lg text-orange-600 font-medium flex items-center">${vendor.Type} Service ${verifiedBadge}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="lg:col-span-2">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Connect & Locate</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${contactItems || '<p class="text-gray-500">No contact information provided.</p>'}
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Service & Pricing Details</h2>
                    ${renderMenu(vendor.DataJSON)}
                </div>
            `;
            renderDeliverySuggestions(vendor);
            lucide.createIcons();
        }

        /**
         * Switches the view to the profile view for a specific vendor.
         */
        function showProfileView(vendorId) {
            const vendor = allVendors.find(v => v.VendorID === vendorId);
            if (!vendor) {
                console.error("Vendor not found:", vendorId);
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold text-red-600 mb-4">Error</h3>
                            <p>Service profile not found for ID: ${vendorId}</p>
                            <button onclick="document.getElementById('error-modal').remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Close</button>
                        </div>
                    </div>
                `);
                return;
            }
            renderProfile(vendor);
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');
            window.scrollTo(0, 0); 
        }

        /**
         * Switches the view back to the list (search) view.
         */
        function showListView() {
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('list-view').classList.remove('hidden');
            applyFilters(); 
        }


        /**
         * Initial data fetch from the Apps Script API.
         */
        async function fetchData() {
            if (APP_SCRIPT_URL === "APP_SCRIPT_URL_PLACEHOLDER") {
                 console.error("FATAL ERROR: Please replace APP_SCRIPT_URL_PLACEHOLDER with your actual deployed Google Apps Script URL.");
                 return;
            }

            const loadingEl = document.getElementById('loading-overlay');
            loadingEl.classList.remove('hidden');

            const maxRetries = 5;
            let currentDelay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(APP_SCRIPT_URL, { method: 'GET' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();

                    if (result.status === "success") {
                        allVendors = result.data;
                        
                        allVendors.forEach(vendor => {
                            vendorTypes.add(vendor.Type);
                            if (vendor.Type === 'Delivery') {
                                deliveryVendors.push(vendor);
                            }
                        });

                        populateTypeFilter();
                        applyFilters(); 
                        renderAdSidebar(); 
                        loadingEl.classList.add('hidden');
                        return;
                    } else {
                        throw new Error(result.message || "Failed to retrieve data.");
                    }

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        document.body.insertAdjacentHTML('beforeend', `
                            <div id="load-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                                <div class="bg-white p-6 rounded-lg shadow-2xl">
                                    <h3 class="text-xl font-bold text-red-600 mb-4">Connection Error</h3>
                                    <p class="mb-4">Could not load service data. Please ensure the Apps Script URL is correct and deployed as a public web app.</p>
                                    <p class="text-sm text-gray-500">Details: ${error.message}</p>
                                    <button onclick="document.getElementById('load-error-modal').remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Acknowledge</button>
                                </div>
                            </div>
                        `);
                        loadingEl.classList.add('hidden');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, currentDelay));
                    currentDelay *= 2; 
                }
            }
        }

        /**
         * Function to manually hide mobile ad
         */
        function hideMobileAd() {
            const mobileAdToast = document.getElementById('mobile-ad-toast');
            mobileAdToast.classList.add('slide-out');
            setTimeout(() => {
                mobileAdToast.innerHTML = '';
            }, 700); 
        }

        /**
         * Renders the Ad sidebar and triggers the mobile ad toast.
         */
        function renderAdSidebar() {
            const adSidebar = document.getElementById('ad-sidebar');
            const mobileAdToast = document.getElementById('mobile-ad-toast'); 
            adSidebar.innerHTML = '';
            mobileAdToast.innerHTML = ''; 

            const availableAds = allVendors.filter(v => v.AdContent && typeof v.AdContent === 'object' && v.AdContent.title && v.AdContent.body);

            if (availableAds.length === 0) {
                 adSidebar.innerHTML = `
                    <div class="ad-placeholder text-center text-gray-400">
                        <p class="text-sm font-semibold text-orange-600 mb-2">AD SPACE</p>
                        <i data-lucide="megaphone" class="mx-auto h-8 w-8"></i>
                        <p class="text-xs mt-2">No active ads currently displayed.</p>
                    </div>
                 `;
            } else {
                const randomAd = availableAds[Math.floor(Math.random() * availableAds.length)];
                
                // 1. Populate Desktop Sidebar
                adSidebar.innerHTML = `
                    <div class="ad-placeholder">
                        <p class="text-sm font-semibold text-orange-600">FEATURED AD</p>
                        <h3 class="text-xl font-bold text-gray-900 mt-1">${randomAd.AdContent.title}</h3>
                        <p class="text-gray-700 mt-2 text-sm">${randomAd.AdContent.body}</p>
                        <button onclick="showProfileView('${randomAd.VendorID}')" class="mt-3 w-full bg-orange-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-orange-700 transition">
                            View Offer
                        </button>
                    </div>
                `;

                // 2. Populate Mobile Ad Toast
                mobileAdToast.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-xl border-l-4 border-orange-500 flex items-center">
                        <div class="flex-shrink-0">
                            <i data-lucide="megaphone" class="h-6 w-6 text-orange-500"></i>
                        </div>
                        <div class="ml-3 flex-grow overflow-hidden">
                            <p class="text-sm font-bold text-gray-900 truncate">${randomAd.AdContent.title}</p>
                            <p class="text-xs text-gray-600 truncate">${randomAd.AdContent.body}</p>
                        </div>
                        <button onclick="showProfileView('${randomAd.VendorID}'); hideMobileAd();" class="ml-2 flex-shrink-0 bg-orange-50 text-orange-600 px-2 py-1 rounded text-xs font-medium">
                            View
                        </button>
                        <button onclick="hideMobileAd()" class="ml-1 flex-shrink-0 text-gray-400 hover:text-gray-600 p-1">
                            <i data-lucide="x" class="h-4 w-4"></i>
                        </button>
                    </div>
                `;
                
                // 3. Trigger Animation
                setTimeout(() => {
                    mobileAdToast.classList.remove('translate-y-[200%]');
                    lucide.createIcons(); // Create icons inside the toast

                    setTimeout(() => {
                        hideMobileAd();
                    }, 5000); // 5 seconds visible
                    
                }, 1500); // 1.5 second delay after load
            }
            lucide.createIcons();
        }

        // Initialize the application on page load
        window.onload = function() {
            fetchData();
        };

    </script>

    <script>
        document.getElementById('footer-copy').innerHTML = `&copy; ${new Date().getFullYear()} Belmopan Service Finder. All rights reserved.`;
    </script>
</body>
</html>
