<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belmopan Service Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .vendor-card { transition: all 0.2s ease; }
        .vendor-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .loading-overlay { background: rgba(255, 255, 255, 0.8); z-index: 100; }
        .ad-placeholder { background-color: #fff; border-left: 4px solid #f97316; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
        .menu-category { border-bottom: 2px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        /* Style for the comparison list inside the card */
        .comparison-list-wrapper { max-height: 100px; overflow-y: auto; padding-right: 4px; border-radius: 4px; }
        .comparison-list-wrapper::-webkit-scrollbar { width: 6px; }
        .comparison-list-wrapper::-webkit-scrollbar-thumb { background: #fed7aa; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Belmopan <span class="text-orange-600">Service Finder</span></h1>
            <p class="mt-2 text-lg text-gray-500">Find Restaurants, Taxis, and Local Services with detailed menus and prices.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <aside class="hidden lg:block lg:col-span-1">
                <div id="ad-sidebar">
                    <div class="ad-placeholder text-center text-gray-400">
                        <p class="text-sm font-semibold text-orange-600 mb-2">AD SPACE</p>
                        <i data-lucide="megaphone" class="mx-auto h-8 w-8"></i>
                        <p class="text-xs mt-2">No active ads currently displayed.</p>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-3">

                <div id="list-view">
                    <div class="mb-8 p-4 bg-white shadow-lg rounded-xl flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="applyFilters()"
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-base"
                                placeholder="Search 'Stew Chicken' or a Business Name...">
                        </div>
                        <div class="relative">
                            <i data-lucide="filter" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                            <select id="type-filter" onchange="applyFilters()"
                                class="w-full sm:w-48 pl-10 pr-4 py-3 border border-gray-300 rounded-lg appearance-none focus:ring-orange-500 focus:border-orange-500 bg-white text-base">
                                <option value="">All Services</option>
                                </select>
                        </div>
                    </div>

                    <div id="vendor-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        </div>

                    <p id="no-results" class="text-center text-gray-500 mt-10 text-xl hidden">
                        No services or menu items found matching your criteria. Try a broader search!
                    </p>
                </div>

                <div id="profile-view" class="hidden">
                    <button onclick="showListView()" class="mb-6 inline-flex items-center text-orange-600 hover:text-orange-800 font-medium p-2 rounded-lg bg-orange-50 hover:bg-orange-100 transition">
                        <i data-lucide="arrow-left" class="h-5 w-5 mr-2"></i>
                        Back to Search Results
                    </button>
                    <div id="profile-details" class="bg-white p-6 shadow-xl rounded-xl">
                        </div>
                    
                    <div id="delivery-suggestions" class="mt-8">
                        </div>
                </div>

            </main>
        </div>
    </div>

    <footer class="mt-12 py-6 bg-gray-800 text-center text-white">
        <p class="text-sm">
            Powered by <span class="font-bold text-orange-500">Pixi Belize</span>. 
            <span class="text-gray-400">This service is free for local vendors.</span>
        </p>
        <p class="text-xs mt-1 text-gray-400">
            Interested in adding your business? Contact us to join!
        </p>
    </footer>

    <script>
        // Use a local JSON file path instead of the Apps Script URL
        const DATA_SOURCE_URL = "list.json"; 

        // Global state
        let allVendors = [];
        let deliveryVendors = []; 
        let vendorTypes = new Set();
        let matchingItemsMap = {}; // Global map to store matched items for comparison view

        /**
         * Converts a simple string to a URL for an icon or image.
         */
        function getIconUrl(url, fallbackText) {
            if (url && (url.startsWith('http') || url.startsWith('data:'))) {
                return url;
            }
            const initials = fallbackText.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            // Adjusted logic to use 'id' if 'name' is unavailable for fallback
            const finalFallbackText = fallbackText || 'BP'; 
            return `https://placehold.co/80x80/22c55e/ffffff?text=${encodeURIComponent(finalFallbackText)}`;
        }

        /**
         * Generates the HTML for social media icons based on vendor data.
         */
        function renderSocialIcons(vendor) {
            let icons = '';
            
            // Normalize contact properties for unified access
            const contactPhone = vendor.phone || vendor.ContactPhone;
            const whatsApp = vendor.whatsAppUrl || vendor.WhatsApp;
            const facebookUrl = vendor.facebookUrl || vendor.FacebookURL;
            const instagramUrl = vendor.instagramUrl || vendor.InstagramURL;

            // Phone and WhatsApp are always important
            if (contactPhone) {
                icons += `<a href="tel:${contactPhone.replace(/=/g, '')}" title="Call ${vendor.name || vendor.Name}" class="text-gray-500 hover:text-orange-600"><i data-lucide="phone" class="h-5 w-5"></i></a>`;
            }
            if (whatsApp) {
                const whatsappNumber = String(whatsApp || '').replace(/\D/g, ''); 
                if (whatsappNumber) {
                    icons += `<a href="https://wa.me/${whatsappNumber}" target="_blank" title="WhatsApp ${vendor.name || vendor.Name}" class="text-gray-500 hover:text-green-500"><i data-lucide="message-square" class="h-5 w-5"></i></a>`;
                }
            }

            // Check for specific social media links
            if (facebookUrl) {
                icons += `<a href="${facebookUrl}" target="_blank" title="Facebook" class="text-gray-500 hover:text-blue-700"><i data-lucide="facebook" class="h-5 w-5"></i></a>`;
            }
            if (instagramUrl) {
                icons += `<a href="${instagramUrl}" target="_blank" title="Instagram" class="text-gray-500 hover:text-pink-600"><i data-lucide="instagram" class="h-5 w-5"></i></a>`;
            }

            return icons;
        }


        /**
         * Renders the list of vendor cards based on the search query and filter.
         */
        function renderVendorList(vendors, currentQuery, matchedItemsMap) {
            const listContainer = document.getElementById('vendor-list');
            const noResults = document.getElementById('no-results');
            listContainer.innerHTML = '';

            if (vendors.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            vendors.forEach(vendor => {
                const card = document.createElement('div');
                card.className = 'vendor-card bg-white p-5 rounded-xl shadow-md border border-gray-100 cursor-pointer flex flex-col justify-between';
                card.onclick = () => showProfileView(vendor.id); // Use 'id' for JSON data

                const iconUrl = getIconUrl(vendor.iconUrl, vendor.id); // Use 'iconUrl' from JSON
                const contactIcons = renderSocialIcons(vendor);
                const matchedItems = matchedItemsMap[vendor.id]; // Use 'id' for JSON data

                // Get vendor name for display (use a placeholder if not present, though the provided JSON doesn't have a 'name' field, it implies one for BPN001 etc.)
                const vendorName = vendor.id || 'Unknown Vendor'; 
                const vendorType = vendor.type || 'General Service'; 

                let cardContentHTML = '';
                
                // Determine if we are in comparison mode (specific item search) or general view
                if (currentQuery && matchedItems && matchedItems.length > 0) {
                    // COMPARISON VIEW: Show specific matched items
                    cardContentHTML = `
                        <p class="text-sm font-semibold text-gray-700 mb-2">Items matching "<strong>${currentQuery}</strong>":</p>
                        <div class="comparison-list-wrapper bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <div class="space-y-1">
                                ${matchedItems.slice(0, 10).map(item => `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-800 font-medium truncate">${item.name}</span>
                                        <span class="text-orange-600 font-bold flex-shrink-0 ml-2">${item.price}</span>
                                    </div>
                                `).join('')}
                                ${matchedItems.length > 10 ? `<p class="text-xs text-gray-500 mt-1">...and ${matchedItems.length - 10} more items</p>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // DEFAULT VIEW: Show Location and "View Profile"
                    cardContentHTML = `
                        <div class="mt-2 mb-4">
                            <div class="flex items-center text-sm text-gray-600">
                                <i data-lucide="map-pin" class="h-4 w-4 mr-2 text-orange-500"></i>
                                <span>${vendor.location || 'Location not specified'}</span>
                            </div>
                            <p class="text-base font-semibold text-orange-600 mt-3 hover:underline">
                                View Profile & Menu Details
                            </p>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.id}')" class="w-16 h-16 rounded-full object-cover mr-4 ring-2 ring-orange-500 p-0.5" alt="${vendorName} Logo">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">${vendorName}</h2>
                            <p class="text-sm text-orange-600 font-semibold">${vendorType}</p>
                        </div>
                    </div>
                    ${cardContentHTML}
                    <div class="mt-auto pt-3 border-t flex space-x-3">
                        ${contactIcons}
                    </div>
                `;
                listContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        /**
         * Filters the vendor list based on search input and type filter.
         */
        function applyFilters() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const typeFilter = document.getElementById('type-filter').value;
            
            // Clear previous matches map
            matchingItemsMap = {}; 

            const filteredVendors = allVendors.filter(vendor => {
                let matchesQuery = false;
                
                // 1. Check Vendor ID (used as name), Location, and Keywords
                // NOTE: 'Name' is not a field in the provided JSON, using 'id' as a stand-in for business name if needed.
                const vendorName = vendor.id || ''; 
                const searchableText = `${vendorName} ${vendor.location || ''} ${vendor.keywords || ''}`.toLowerCase();
                if (searchableText.includes(query)) {
                    matchesQuery = true;
                }

                // 2. Check Menu Items (Deep Search for Comparison)
                const matchedItems = [];
                // Handle the 'data' field being a JSON string or a parsed object
                let vendorData = null;
                try {
                    vendorData = typeof vendor.data === 'string' && vendor.data.trim() !== "" ? JSON.parse(vendor.data) : vendor.data;
                } catch(e) {
                    console.error("Error parsing vendor data for ID:", vendor.id, e);
                    vendorData = [];
                }
                
                if (Array.isArray(vendorData)) {
                    vendorData.forEach(category => {
                        if (category.items && Array.isArray(category.items)) {
                            category.items.forEach(item => {
                                // Check if item name or description contains the query
                                if ((item.name || '').toLowerCase().includes(query) || (item.desc || '').toLowerCase().includes(query)) {
                                    matchedItems.push({
                                        name: item.name,
                                        price: item.price || 'Price N/A'
                                    });
                                    matchesQuery = true; // The vendor definitely matches if an item matches
                                }
                            });
                        }
                    });
                }

                if (matchedItems.length > 0) {
                    matchingItemsMap[vendor.id] = matchedItems;
                }
                
                // 3. Check Type Filter
                const matchesType = !typeFilter || vendor.type === typeFilter;
                
                return matchesQuery && matchesType;
            });

            renderVendorList(filteredVendors, query, matchingItemsMap);
        }

        /**
         * Populates the Service Type filter dropdown.
         */
        function populateTypeFilter() {
            const filterEl = document.getElementById('type-filter');
            filterEl.querySelectorAll('option:not([value=""])').forEach(opt => opt.remove());

            vendorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterEl.appendChild(option);
            });
        }

        /**
         * Renders the full, categorized menu from the vendor's data object.
         */
        function renderMenu(dataJson) {
            // Handle the 'data' field being a JSON string or a parsed object
            let parsedData = null;
            try {
                parsedData = typeof dataJson === 'string' && dataJson.trim() !== "" ? JSON.parse(dataJson) : dataJson;
            } catch(e) {
                console.error("Error parsing menu data:", e);
                return '<p class="text-red-500">Error loading service details.</p>';
            }

            if (!parsedData || parsedData.length === 0) {
                return '<p class="text-gray-500">No detailed menu or service list available.</p>';
            }

            let menuHTML = '';

            const categories = Array.isArray(parsedData) ? parsedData : [{ category: "Details", description: "Services offered:", items: parsedData.items || [] }];

            categories.forEach(category => {
                menuHTML += `
                    <div class="menu-category">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">${category.category}</h3>
                        <p class="text-gray-600 mb-4">${category.description || ''}</p>
                        <div class="space-y-3">
                `;
                (category.items || []).forEach(item => { 
                    menuHTML += `
                        <div class="flex justify-between items-start border-b border-gray-100 pb-2">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${item.name || 'Untitled Item'}</p>
                                <p class="text-sm text-gray-500 italic">${item.desc || ''}</p>
                            </div>
                            <p class="text-lg font-bold text-orange-600 flex-shrink-0 ml-4">${item.price || 'Varies'}</p>
                        </div>
                    `;
                });
                menuHTML += `
                        </div>
                    </div>
                `;
            });

            return menuHTML;
        }

        /**
         * Renders suggestions for Delivery services, only if the current vendor is a Restaurant.
         */
        function renderDeliverySuggestions(currentVendor) {
            const suggestionsContainer = document.getElementById('delivery-suggestions');
            suggestionsContainer.innerHTML = '';
            
            // Assume vendors with 'wings', 'burgers', 'pizza' in keywords are 'Restaurant' for this logic, 
            // as 'type' is often empty in the provided JSON
            const isRestaurant = currentVendor.keywords && (currentVendor.keywords.toLowerCase().includes('wings') || currentVendor.keywords.toLowerCase().includes('pizza') || currentVendor.keywords.toLowerCase().includes('burgers'));
            
            if (!isRestaurant || deliveryVendors.length === 0) {
                return; // Only suggest delivery for restaurants/food vendors
            }

            const shuffledDelivery = deliveryVendors.sort(() => 0.5 - Math.random());
            let deliveryCards = shuffledDelivery.slice(0, 3).map(vendor => { 
                const iconUrl = getIconUrl(vendor.iconUrl, vendor.id);
                return `
                    <div class="flex items-center p-4 bg-white rounded-lg shadow-sm border border-orange-200 cursor-pointer transition hover:bg-orange-50" onclick="showProfileView('${vendor.id}')">
                        <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.id}')" class="w-10 h-10 rounded-full object-cover mr-3" alt="${vendor.id} Logo">
                        <div>
                            <p class="font-semibold text-gray-900">${vendor.id}</p>
                            <p class="text-sm text-orange-600">Tap to see rates</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 ml-auto text-gray-400"></i>
                    </div>
                `;
            }).join('');
            
            // Use 'id' as a stand-in for vendor name
            const currentVendorName = currentVendor.id || 'this vendor';

            suggestionsContainer.innerHTML = `
                <div class="p-5 bg-orange-100 rounded-xl">
                    <h2 class="text-2xl font-bold text-orange-800 mb-4">Need Delivery for ${currentVendorName}?</h2>
                    <p class="text-gray-700 mb-4">Check out these trusted local delivery services who can bring your order right to your door:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${deliveryCards}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        /**
         * Renders the detailed profile view for a specific vendor.
         */
        function renderProfile(vendor) {
            const profileContainer = document.getElementById('profile-details');
            const iconUrl = getIconUrl(vendor.iconUrl, vendor.id);

            // Use 'id' as a stand-in for vendor name
            const vendorName = vendor.id || 'Unknown Vendor'; 
            const vendorType = vendor.type || 'General Service'; 

            let contactItems = '';
            
            // Build the contact/social section, using JSON property names
            if (vendor.location) {
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="map-pin" class="h-5 w-5 text-gray-500 mr-3"></i><span class="text-gray-800">${vendor.location}</span></div>`;
            }
            if (vendor.phone) {
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="phone" class="h-5 w-5 text-gray-500 mr-3"></i><a href="tel:${vendor.phone.replace(/=/g, '')}" class="text-blue-600 hover:underline">${vendor.phone.replace(/=/g, '')} (Call)</a></div>`;
            }
            if (vendor.whatsAppUrl) {
                const whatsappNumber = String(vendor.whatsAppUrl || '').replace(/\D/g, ''); 
                if (whatsappNumber) {
                     contactItems += `<div class="flex items-center mb-2"><i data-lucide="message-square" class="h-5 w-5 text-green-500 mr-3"></i><a href="https://wa.me/${whatsappNumber}" target="_blank" class="text-green-600 hover:underline">Chat on WhatsApp</a></div>`;
                }
            }
            if (vendor.facebookUrl) {
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="facebook" class="h-5 w-5 text-blue-700 mr-3"></i><a href="${vendor.facebookUrl}" target="_blank" class="text-blue-600 hover:underline">Visit Facebook Page</a></div>`;
            }
            if (vendor.instagramUrl) {
                contactItems += `<div class="flex items-center mb-2"><i data-lucide="instagram" class="h-5 w-5 text-pink-600 mr-3"></i><a href="${vendor.instagramUrl}" target="_blank" class="text-pink-600 hover:underline">Visit Instagram Profile</a></div>`;
            }

            profileContainer.innerHTML = `
                <div class="flex flex-col md:flex-row items-center md:items-start border-b pb-6 mb-6">
                    <img src="${iconUrl}" onerror="this.onerror=null; this.src=getIconUrl(null, '${vendor.id}')" class="w-24 h-24 rounded-full object-cover mb-4 md:mb-0 md:mr-6 ring-4 ring-orange-500 p-0.5" alt="${vendorName} Logo">
                    <div>
                        <h1 class="text-3xl font-extrabold text-gray-900">${vendorName}</h1>
                        <p class="text-lg text-orange-600 font-medium">${vendorType} Service</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="lg:col-span-2">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Connect & Locate</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${contactItems || '<p class="text-gray-500">No contact information provided.</p>'}
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Service & Pricing Details</h2>
                    ${renderMenu(vendor.data)}
                </div>
            `;
            // Suggest delivery services if it's a restaurant
            renderDeliverySuggestions(vendor);
            lucide.createIcons();
        }

        /**
         * Switches the view to the profile view for a specific vendor.
         */
        function showProfileView(vendorId) {
            const vendor = allVendors.find(v => v.id === vendorId);
            if (!vendor) {
                console.error("Vendor not found:", vendorId);
                // Fallback: simple message box
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold text-red-600 mb-4">Error</h3>
                            <p>Service profile not found for ID: ${vendorId}</p>
                            <button onclick="document.getElementById('error-modal').remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Close</button>
                        </div>
                    </div>
                `);
                return;
            }
            renderProfile(vendor);
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');
            window.scrollTo(0, 0); 
        }

        /**
         * Switches the view back to the list (search) view.
         */
        function showListView() {
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('list-view').classList.remove('hidden');
            applyFilters(); // Re-render the filtered/full list
        }


        /**
         * Initial data fetch from the local JSON file.
         */
        async function fetchData() {
            const loadingEl = document.getElementById('loading-overlay');
            loadingEl.classList.remove('hidden');

            try {
                // Fetch the local JSON file
                const response = await fetch(DATA_SOURCE_URL, { method: 'GET' });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} when fetching local JSON.`);
                }

                // The response is the array of vendors directly
                const result = await response.json();

                // Map 'type' based on keywords for empty entries, a common pattern for the provided JSON data
                allVendors = result.map(vendor => {
                    if (!vendor.type && vendor.keywords) {
                        const lowerKeywords = vendor.keywords.toLowerCase();
                        if (lowerKeywords.includes('pizza') || lowerKeywords.includes('wings') || lowerKeywords.includes('burgers') || lowerKeywords.includes('salads') || lowerKeywords.includes('pasta')) {
                            vendor.type = 'Restaurant';
                        } else if (lowerKeywords.includes('delivery') || lowerKeywords.includes('taxi') || lowerKeywords.includes('transfer')) {
                            vendor.type = 'Delivery/Transport';
                        } else if (lowerKeywords.includes('plumbing') || lowerKeywords.includes('electrical') || lowerKeywords.includes('tools') || lowerKeywords.includes('lumber')) {
                            vendor.type = 'Hardware/Supply';
                        } else if (lowerKeywords.includes('websites')) {
                            vendor.type = 'Web Service';
                        } else {
                            vendor.type = 'Misc Service';
                        }
                    } else if (!vendor.type) {
                        vendor.type = 'Misc Service';
                    }
                    return vendor;
                });
                
                // Populate vendor types for filtering
                allVendors.forEach(vendor => {
                    vendorTypes.add(vendor.type);
                    if (vendor.type.includes('Delivery')) { // Use includes for both Delivery and Delivery/Transport
                        deliveryVendors.push(vendor);
                    }
                });

                populateTypeFilter();
                applyFilters(); // Initial render of the list
                renderAdSidebar(); // Render the ads
                loadingEl.classList.add('hidden');
                
            } catch (error) {
                document.body.insertAdjacentHTML('beforeend', `
                    <div id="load-error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-2xl">
                            <h3 class="text-xl font-bold text-red-600 mb-4">Data Loading Error</h3>
                            <p class="mb-4">Could not load service data from ${DATA_SOURCE_URL}. Make sure the file exists in the same directory.</p>
                            <p class="text-sm text-gray-500">Details: ${error.message}</p>
                            <button onclick="document.getElementById('load-error-modal').remove()" class="mt-4 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Acknowledge</button>
                        </div>
                    </div>
                `);
                loadingEl.classList.add('hidden');
            }
        }

        /**
         * Renders the Ad sidebar from all available approved AdContent.
         */
        function renderAdSidebar() {
            const adSidebar = document.getElementById('ad-sidebar');
            adSidebar.innerHTML = '';
            
            // Collect all vendors with valid ad content
            const availableAds = allVendors.filter(v => {
                let adData = v.adContent;
                // Check if adContent is a TRUE string or an object with title/body
                if (typeof adData === 'string') {
                    // Check for the known ad-as-string formats from the JSON
                    if (adData.toUpperCase() === 'TRUE' || adData.startsWith('{"title"')) {
                        try {
                            // If it's a JSON string, parse it to see if it's a structured ad
                            const parsedAd = JSON.parse(adData);
                            return parsedAd.title && parsedAd.body;
                        } catch (e) {
                            // If it's just 'TRUE' (or a simple string) and no structured ad, skip it for the sidebar.
                            return false; 
                        }
                    }
                }
                // Check for the structured ad object
                return adData && typeof adData === 'object' && adData.title && adData.body;
            });

            if (availableAds.length === 0) {
                 adSidebar.innerHTML = `
                    <div class="ad-placeholder text-center text-gray-400">
                        <p class="text-sm font-semibold text-orange-600 mb-2">AD SPACE</p>
                        <i data-lucide="megaphone" class="mx-auto h-8 w-8"></i>
                        <p class="text-xs mt-2">No active ads currently displayed.</p>
                    </div>
                 `;
            } else {
                // For simplicity, pick a random ad to display
                const randomAdVendor = availableAds[Math.floor(Math.random() * availableAds.length)];
                let adContent = randomAdVendor.adContent;

                // Handle adContent being a JSON string for structured ads
                if (typeof adContent === 'string' && adContent.startsWith('{"title"')) {
                    try {
                        adContent = JSON.parse(adContent);
                    } catch(e) {
                         // Should not happen if the filter was correct, but as a safeguard
                         adContent = { title: "Special Offer!", body: "Click to see a deal from this vendor." };
                    }
                }
                
                adSidebar.innerHTML = `
                    <div class="ad-placeholder">
                        <p class="text-sm font-semibold text-orange-600">FEATURED AD</p>
                        <h3 class="text-xl font-bold text-gray-900 mt-1">${adContent.title}</h3>
                        <p class="text-gray-700 mt-2 text-sm">${adContent.body}</p>
                        <button onclick="showProfileView('${randomAdVendor.id}')" class="mt-3 w-full bg-orange-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-orange-700 transition">
                            View Offer
                        </button>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // Initialize the application on page load
        window.onload = function() {
            fetchData();
        };

    </script>
</body>
</html>
